name: Export issues
on:
  issues:
    types: [closed]
  workflow_dispatch:
 # schedule:
    # run every 8 hours
  #  - cron:  '0 0,8,16 * * *'
jobs:
  issue:
    runs-on: ubuntu-latest
    name: discord
    steps:
     - name: Set env data
       id: propdata
       run: |
         if [[ ${{ fromJSON(github.event.issue.body).fund == 'Fund6' }} ]]; then
              echo "::set-output name=data::$(curl -s https://raw.githubusercontent.com/treasuryguild/treasury-v3/main/proposals/F6-${{ fromJSON(github.event.issue.body).proposal }}.json | jq '.wallet' | sed 's/\"//g')"
          else if [[ ${{ fromJSON(github.event.issue.body).fund == 'Fund7' }} ]]; then
              echo "::set-output name=data::$(curl -s https://raw.githubusercontent.com/treasuryguild/treasury-v3/main/proposals/F7-${{ fromJSON(github.event.issue.body).proposal }}.json | jq '.wallet' | sed 's/\"//g')"
          else if [[ ${{ fromJSON(github.event.issue.body).fund == 'Fund8' }} ]]; then
              echo "::set-output name=data::$(curl -s https://raw.githubusercontent.com/treasuryguild/treasury-v3/main/proposals/F8-${{ fromJSON(github.event.issue.body).proposal }}.json | jq '.wallet' | sed 's/\"//g')"    
          fi
  #       echo "::set-output name=data::$(curl -s https://raw.githubusercontent.com/treasuryguild/treasury-v3/main/proposals/F8-${{ fromJSON(github.event.issue.body).proposal }}.json | jq '.wallet' | sed 's/\"//g')"
     - name: Set env wallet
       run: |
         echo "wallet=${{ steps.propdata.outputs.data }}" >> "$GITHUB_ENV"
     - name: Test Custom
       if: ${{ (github.event.issue.labels[0].name == 'Incoming' && fromJSON(github.event.issue.body).proposal == 'Treasury-Swarm-pool-Rewards') }}
       uses: rjstone/discord-webhook-notify@v1
       with:
         severity: info
         username: Treasury Guild
         color: '#03fc2c'
         avatarUrl: https://github.com/CC-Treasury/issueblog/raw/main/Untitled-1.png
         description: |
           `Payment Info - ${{ fromJSON(github.event.issue.body).project }} - ${{ fromJSON(github.event.issue.body).fund }}` - [Ideascale](${{ fromJSON(github.event.issue.body).ideascale }})
         details: | 
           ```fix
           ${{ fromJSON(github.event.issue.body).proposal }} | ${{ fromJSON(github.event.issue.body).budget }} | = ${{ fromJSON(github.event.issue.body).name }}
           ```
           `Amount Received` - [CardanoScan](https://cardanoscan.io/transaction/${{ fromJSON(github.event.issue.body).txid }}) - [GitBook](https://treasury-guild.gitbook.io/cardano4climate/)
           ```md
           * ADA - ${{ fromJSON(github.event.issue.body).ada }} 
           * GMBL - ${{ fromJSON(github.event.issue.body).gmbl }}
           * AGIX - ${{ fromJSON(github.event.issue.body).agix }}
           ```
           `Description` - `${{ fromJSON(github.event.issue.body).description }}`
           
           `Wallet Balance of` [${{ fromJSON(github.event.issue.body).proposal }}](https://pool.pm/${{ env.wallet }})
           ```css
           ${{ fromJSON(github.event.issue.body).wallet-balance[0] }} ${{ fromJSON(github.event.issue.body).wallet-balance[1] }} ${{ fromJSON(github.event.issue.body).wallet-balance[2] }}
           ```    
         footer: Exchange Rate - ${{ fromJSON(github.event.issue.body).exchange-rate }}
         text: ${{ github.event.issue.title }}
         webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
     - name: Test Custom2
       if: ${{ (github.event.issue.labels[0].name == 'Outgoing' && fromJSON(github.event.issue.body).proposal == 'Treasury-Swarm-pool-Rewards') }}
       uses: rjstone/discord-webhook-notify@v1
       with:
         severity: info
         username: Treasury Guild
         color: '#ff00aa'
         avatarUrl: https://github.com/CC-Treasury/issueblog/raw/main/Untitled-1.png
         description: |
           `Payment Info - ${{ fromJSON(github.event.issue.body).project }} - ${{ fromJSON(github.event.issue.body).fund }}` - [Ideascale](${{ fromJSON(github.event.issue.body).ideascale }})
         details: | 
           ```fix
           ${{ fromJSON(github.event.issue.body).proposal }} | ${{ fromJSON(github.event.issue.body).budget }} | = ${{ fromJSON(github.event.issue.body).name }}
           ```
           `Payment Amount` - [CardanoScan](https://cardanoscan.io/transaction/${{ fromJSON(github.event.issue.body).txid }}) - [GitBook](https://treasury-guild.gitbook.io/cardano4climate/)
           ```md
           * ADA - ${{ fromJSON(github.event.issue.body).ada }} 
           * GMBL - ${{ fromJSON(github.event.issue.body).gmbl }}
           * AGIX - ${{ fromJSON(github.event.issue.body).agix }}
           ```
           `Description` - `${{ fromJSON(github.event.issue.body).description }}`
           
           `Wallet Balance of` [${{ fromJSON(github.event.issue.body).proposal }}](https://pool.pm/${{ env.wallet }})
           ```css
           ${{ fromJSON(github.event.issue.body).wallet-balance[0] }} ${{ fromJSON(github.event.issue.body).wallet-balance[1] }} ${{ fromJSON(github.event.issue.body).wallet-balance[2] }}
           ```    
         footer: Exchange Rate - ${{ fromJSON(github.event.issue.body).exchange-rate }}
         text: ${{ github.event.issue.title }}
         webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
     - name: Test Custom3
       if: ${{ (github.event.issue.labels[0].name == 'Incoming' && fromJSON(github.event.issue.body).proposal != 'Treasury-Swarm-pool-Rewards') }}
       uses: rjstone/discord-webhook-notify@v1
       with:
         severity: info
         username: Treasury Guild
         color: '#03fc2c'
         avatarUrl: https://github.com/CC-Treasury/issueblog/raw/main/Untitled-1.png
         description: |
           `Payment Info - ${{ fromJSON(github.event.issue.body).project }} - ${{ fromJSON(github.event.issue.body).fund }}` - [Ideascale](${{ fromJSON(github.event.issue.body).ideascale }})
         details: | 
           ```fix
           ${{ fromJSON(github.event.issue.body).proposal }} | ${{ fromJSON(github.event.issue.body).budget }} | = ${{ fromJSON(github.event.issue.body).name }}
           ```
           `Amount Received` - [CardanoScan](https://cardanoscan.io/transaction/${{ fromJSON(github.event.issue.body).txid }}) - [GitBook](https://treasury-guild.gitbook.io/cardano4climate/)
           ```md
           * ADA - ${{ fromJSON(github.event.issue.body).ada }} 
           ```
           `Description` - `${{ fromJSON(github.event.issue.body).description }}`
           
           `Wallet Balance of` [${{ fromJSON(github.event.issue.body).proposal }}](https://pool.pm/${{ env.wallet }})
           ```css
           ${{ fromJSON(github.event.issue.body).wallet-balance[0] }} ${{ fromJSON(github.event.issue.body).wallet-balance[1] }} ${{ fromJSON(github.event.issue.body).wallet-balance[2] }}
           ```    
         footer: Exchange Rate - ${{ fromJSON(github.event.issue.body).exchange-rate }}
         text: ${{ github.event.issue.title }}
         webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
     - name: Test Custom4
       if: ${{ (github.event.issue.labels[0].name == 'Outgoing' && fromJSON(github.event.issue.body).proposal != 'Treasury-Swarm-pool-Rewards') }}
       uses: rjstone/discord-webhook-notify@v1
       with:
         severity: info
         username: Treasury Guild
         color: '#ff00aa'
         avatarUrl: https://github.com/CC-Treasury/issueblog/raw/main/Untitled-1.png
         description: |
           `Payment Info - ${{ fromJSON(github.event.issue.body).project }} - ${{ fromJSON(github.event.issue.body).fund }}` - [Ideascale](${{ fromJSON(github.event.issue.body).ideascale }})
         details: | 
           ```fix
           ${{ fromJSON(github.event.issue.body).proposal }} | ${{ fromJSON(github.event.issue.body).budget }} | = ${{ fromJSON(github.event.issue.body).name }}
           ```
           `Payment Amount` - [CardanoScan](https://cardanoscan.io/transaction/${{ fromJSON(github.event.issue.body).txid }}) - [GitBook](https://treasury-guild.gitbook.io/cardano4climate/)
           ```md
           * ADA - ${{ fromJSON(github.event.issue.body).ada }} 
           ```
           `Description` - `${{ fromJSON(github.event.issue.body).description }}`
           
           `Wallet Balance of` [${{ fromJSON(github.event.issue.body).proposal }}](https://pool.pm/${{ env.wallet }})
           ```css
           ${{ fromJSON(github.event.issue.body).wallet-balance[0] }} ${{ fromJSON(github.event.issue.body).wallet-balance[1] }} ${{ fromJSON(github.event.issue.body).wallet-balance[2] }}
           ```    
         footer: Exchange Rate - ${{ fromJSON(github.event.issue.body).exchange-rate }}
         text: ${{ github.event.issue.title }}
         webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
